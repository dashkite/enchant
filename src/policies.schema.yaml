$schema: "https://json-schema.org/draft/2020-12/schema"

title: Enchant Policy

$defs:

  property:
    title: Property
    description: >-
      A key-value pair that will be loaded into the context,
      referenceable from conditions and actions.
    type: object
    properties:
      name:
        description: >-
          The name of the context property, used to reference
          it in conditions and actions.
        type: string
        pattern: '^[a-z_]+$'
      expression:
        description: >-
          An expression that will be evaluted to determine the value
          of the context property.
        type: string
    required:
      - name
      - expression
    additionalProperties: false
    
  condition:
    title: Condition
    type: object
    properties:
      name: 
        type: string
      input:
        type: string
    additionalProperties: false
  action:
    title: Action
    type: object
    properties:
      name:
        type: string
      input:
        type: string
    additionalProperties: false
  rule:
    title: Rule
    type: object
    properties:
      context:
        type: array
        items:
          type: array
          items:
            $ref: '#/$defs/property'
      conditions:
        type: array
        items:
          $ref: '#/$defs/condition'
      actions:
        type: array
        items:
          $ref: '#/$defs/action'
  policy:
    title: Policy
    type: object
    properties:
      resources:
        type: object
        properties:
          include:
            type: array
            items: string
          exclude:
            type: array
            items: string
        additionalProperties: false
      request:
        type: array
        items:
          $ref: '#/$defs/rule'
      response:
        type: array
        items:
          $ref: '#/$defs/rule'


type: object
patternProperties:
  # dictionary of domain -> policy array
  '^([a-z]\.){2,}\.[a-z]$':
    type: array
    items:
      $ref: '#/$defs/policy'
additionalProperties: false